<!DOCTYPE html>
<html lang="en">

<head>
    <title>HTTP Server</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Fusion :: Documentation">
    <meta name="author" content="Yupiik Minisite Generator">
    <meta name="generator" content="Yupiik Minisite Generator">
    
    <link rel="shortcut icon" href="//www.yupiik.io/images/favicon.png">

    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i|Montserrat:300,400,500,700" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/asciidoctor.js/1.5.5-5/css/asciidoctor.min.css" integrity="sha512-kI7tn5cuEg16kMeXnYmg8rEJPxbxzEM7Gsr191iQdLDevFBLXPCSU9aZWSVuP61tMZWU3nBAR1cJ7SmXnOGLZw==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css" integrity="sha512-oc9+XSs1H243/FRN9Rw62Fn8EtxjEYWHXRvjS43YtueEewbS6ObfXcJNyohjHqVKFPoXXUxwc+q1K7Dee6vv9g==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/vs2015.min.css" integrity="sha512-w8aclkBlN3Ha08SMwFKXFJqhSUx2qlvTBFLLelF8sm4xQnlg64qmGB/A6pBIKy0W8Bo51yDMDtQiPLNRq1WMcQ==" crossorigin="anonymous" />
    <link id="theme-style" rel="stylesheet" href="//www.yupiik.io/fusion/css/theme.css?v=1.0.13-SNAPSHOT">
    
</head>
<body>
    <header class="header fixed-top">
        <div class="branding docs-branding">
            <div class="container-fluid position-relative py-2">
                <div class="docs-logo-wrapper">
	                <div class="site-logo"><a title="Home" class="navbar-brand" href="//www.yupiik.io/fusion/index.html">
	                <img class="logo-icon mr-2" src="//www.yupiik.io/images/favicon.png" alt="logo">
	                <span class="logo-text">Fusion :: Documentation <span class="text-alt">Docs</span></span></a></div>
                </div>
	            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
					
					<li class="list-inline-item"><a title="Search" id="search-button" href="#" data-toggle="modal" data-target="#searchModal"><i data-toggle="tooltip" data-placement="top" title="Search" class="fas fa-search"></i></a></li>

					<ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
						
						<li class="list-inline-item"><a href="https://www.github.com/yupiik/"><i class="fab fa-github fa-fw"></i></a></li><li class="list-inline-item"><a href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
		            </ul>
	            </div>
            </div>
        </div>
    </header>
	<div class="page">
        <div class="page-navigation-left">
            <h3>Menu</h3>
            <ul>
                <li>
                    <a title="Fusion Stack" href="//www.yupiik.io/fusion/fusion/index.html">
                        <i class="fas fa-play"></i>Getting Started
                    </a>
                </li>                <li>
                    <a title="Fusion framework Examples" href="//www.yupiik.io/fusion/fusion/examples.html">
                        <i class="fas fa-vial"></i>Example
                    </a>
                </li>                <li>
                    <a title="Fusion framework Setup" href="//www.yupiik.io/fusion/fusion/setup.html">
                        <i class="fas fa-building"></i>Setup
                    </a>
                </li>                <li>
                    <a title="Fusion JSON support" href="//www.yupiik.io/fusion/fusion/json.html">
                        <i class="fas fa-wifi"></i>JSON
                    </a>
                </li>                <li>
                    <a title="Fusion CLI" href="//www.yupiik.io/fusion/fusion/cli.html">
                        <i class="fas fa-terminal"></i>CLI
                    </a>
                </li>                <li>
                    <a title="framework and GraalVM (native-image)" href="//www.yupiik.io/fusion/fusion/graalvm.html">
                        <i class="fas fa-server"></i>GraalVM
                    </a>
                </li>
            </ul>
        </div>

        <div id="fusion-http-server-html-container" class="container page-content fusion-http-server-html">
                        <div class="page-header">
                <h1>HTTP Server</h1>
            </div>
            <div class="page-content-body">
                <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>HTTP server module provides an abstraction over an Apache Tomcat server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dependency">Dependency</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.yupiik.fusion&lt;/groupId&gt;
  &lt;artifactId&gt;fusion-http-server&lt;/artifactId&gt;
  &lt;version&gt;${fusion.version}&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
annotations - design API - is in <code>fusion-build-api</code> and is only useful at build time.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
set tomcat-catalina in scope runtime to avoid to show the internal API if you don&#8217;t need them, will also avoid to let your IDE complete javakarta.* transitive dependencies of tomcat.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage">Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, if you use Fusion IoC, the webservice will be started.
You can customize the configuration listening for <code>WebServer.Configuration</code> event.</p>
</div>
<div class="paragraph">
<p>Defining an endpoint can be done creating an <code>Endpoint</code> bean and implementing the matcher (<code>matches</code>) and handler which will return a <code>Response</code> thanks the builder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public class Greeting implements Endpoint {
    @Override
    public boolean matches(final Request request) {
        return "GET".equals(request.method());
    }

    @Override
    public CompletionStage&lt;Response&gt; handle(final Request request) {
        return completedFuture(Response.of()
                .body("{\"hello\":true}")
                .build());
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of the configuration can be customized using an event listener on <code>WebServer.Configuration</code> and unwrapping the instance as a <code>TomcatWebServerConfiguration</code> you have access to a full Tomcat server customization (HTTP/2.0, WebSocket and so on).</p>
</div>
<div class="paragraph">
<p>However, there are a few system properties/environment variables (uppercased and with underscores instead of dots) you can set:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To skip the initialization of the server at startup: <code>fusion.http-server.start=[true|false]</code>. This can be useful to not start the server in tests for example,</p>
</li>
<li>
<p>To set the HTTP port to use: <code>fusion.http-server.port=&lt;port&gt;</code>, note that setting 0 will make the port random and you can inject <code>WebServer.Configuration</code> to read its value,</p>
</li>
<li>
<p>To set the host to use: <code>fusion.http-server.host=&lt;host&gt;</code>,</p>
</li>
<li>
<p>To set the access log pattern to use: <code>fusion.http-server.accessLogPattern=&lt;&#8230;&#8203;&gt;</code>, see <a href="https://tomcat.apache.org/tomcat-11.0-doc/config/valve.html#Access_Logging">Tomcat</a> documentation for pattern details,</p>
</li>
<li>
<p>To set the webapp directory: <code>fusion.http-server.base=/path/to/www</code>. It can be useful to serve static websites if you configure the right servlets,</p>
</li>
<li>
<p>To set the fusion default servlet mapping: <code>fusion.http-server.fusionServletMapping=/</code>. It can be useful if you want to bind it to a subcontext to use standard servlets for other things like serving base directory,</p>
</li>
<li>
<p>To set if UTF-8 is enforced (default) or not over the requests/responses: <code>fusion.http-server.utf8Setup=true</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, you can also set by default the deployment of a monitoring server (for health checks or metrics depending your application).
This is done setting <code>fusion.http-server.monitoring.enabled</code> to <code>true</code>, optionally <code>fusion.http-server.monitoring.port</code> to something else than <code>8081</code>.
The deployed endpoints in this context will be the <code>MonitoringEndpoint</code> bean instances.</p>
</div>
<div class="paragraph">
<p>Here is a sample <code>MonitoringEndpoint</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@DefaultScoped
public class Health implements MonitoringEndpoint {
    private final TransactionManager transactionManager;

    public Health(final TransactionManager transactionManager) {
        this.transactionManager = transactionManager;
    }

    @Override
    public boolean matches(final Request request) {
        return "GET".equalsIgnoreCase(request.method()) &amp;&amp; "/metrics".equalsIgnoreCase(request.path());
    }

    @Override
    public CompletionStage&lt;Response&gt; unsafeHandle(final Request request) {
        return transactionManager
                .read(c -&gt; {
                    try {
                        if (!c.isValid(30_000)) {
                            return Optional.of(fail("Timeout"));
                        }
                        return Optional.&lt;CompletionStage&lt;Response&gt;&gt;empty();
                    } catch (final SQLException e) {
                        return Optional.of(fail(e.getMessage()));
                    }
                })
                .orElseGet(() -&gt; completedStage(Response.of().body("OK").build()));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_high_level_api">High level API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first option to define an endpoint as a bean - automatically picked - is to use <code>Endpoint.of</code> API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public Endpoint myGreetingEndpoint() {
    return Endpoint.of(
            // matching impl
            request -&gt; "GET".equals(request.method()) &amp;&amp;
                request.path().startsWith("/greet") &amp;&amp;
                request.query() != null &amp;&amp;
                request.query().startsWith("name="),
            // endpoint impl - can be delegated to any bean
            request -&gt; completableStage(Response.of()
                .status(200)
                .header("content-type", "application/json")
                .body(jsonMapper.toString(
                        new Greet(request.query().substring("name=".length()))))
                .build()));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The alternative is to use <code>@HttpMatcher</code> API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@HttpMatcher(method = "GET", pathMatching = EXACT, path = "/greet")
public CompletionStage&lt;Response&gt; myGreetingEndpoint() {
    return completableStage(Response.of()
        .status(200)
        .header("content-type", "application/json")
        .body(jsonMapper.toString(
                new Greet(request.query().substring("name=".length()))))
        .build());
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
if your endpoint is fully synchronous you can drop the <code>CompletionStage</code> wrapper: <code>public CompletionStage&lt;Response&gt; myGreetingEndpoint();</code>.
You can also pass as first parameter a <code>Request</code> parameter.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server-tracing">(Open) Tracing</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>fusion-tracing</code> module provides a Tomcat valve you can set up on your web container to add tracing capabilities to your Tomcat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">serverConfiguration
    .unwrap(TomcatWebServerConfiguration.class)
    .setContextCustomizers(List.of(c -&gt; c.getPipeline() <b class="conum">(1)</b>
        .addValve(new TracingValve( <b class="conum">(1)</b>
            new ServerTracingConfiguration(), <b class="conum">(2)</b>
            new AccumulatingSpanCollector().setOnFlush(...), <b class="conum">(3)</b>
            new IdGenerator(IdGenerator.Type.HEX), <b class="conum">(4)</b>
            systemUTC())))); <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Add the valve to the context pipeline, it is recommended to add it as early as possible (just after error report and access log valve in general),</p>
</li>
<li>
<p>The configuration enables to customize the span tags and headers to read for span propagation,</p>
</li>
<li>
<p>The accumulator is what will send/log/&#8230;&#8203; the spans once aggregated, ensure to configure it as needed,</p>
</li>
<li>
<p>The <code>IdGenerator</code> provides the span/trace identifiers, it must be compatible with your collector (<code>hex</code> for zipkin for example),</p>
</li>
<li>
<p>Finally the clock enables to timestamp the span and compute its duration.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
if you reuse <code>AccumulatingSpanCollector</code>, it is automatically closed with the valve "stop" phase.
You can combine the accumulator with <code>ZipkinFlusher</code> <code>onFlush</code> implementation to flush to a zipkin collector v2.
</td>
</tr>
</table>
</div>
</div>
</div>
                
            </div>
        </div>
    <div class="page-navigation-right">
        <h3>Navigation</h3>
        <nav class="generated-nav-menu"></nav>
    </div>
    </div>
    <hr />
    <footer class="footer pb-5">
	    <div class="footer-bottom text-center">
		    <ul class="social-list list-unstyled">
                <li class="list-inline-item"><a href="https://www.github.com/yupiik/"><i class="fab fa-github fa-fw"></i></a></li><li class="list-inline-item"><a href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
	        </ul>
            <small class="copyright">Yupiik &copy;</small> | <a href="https://www.yupiik.com/terms-of-service/">Terms of service</a> | <a href="https://www.yupiik.com/privacy-policy/">Privacy policy</a>
	    </div>
    </footer>

    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">Search</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form onsubmit="return false;" class="form-inline">
          <div class="form-group">
            <label for="searchInput"><b>Search: </b></label>
            <input class="form-control" id="searchInput" placeholder="Enter search text and hit enter...">
          </div>
        </form>
        <div class="search-hits"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js" integrity="sha512-8qmis31OQi6hIRgvkht0s6mCOittjMa9GMqtK9hes5iEQBQE/Ca6yGE5FsW36vyipGoWQswBj/QBm2JR086Rkw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/highlight.min.js" integrity="sha512-d00ajEME7cZhepRqSIVsQVGDJBdZlfHyQLNC6tZXYKTG7iwcF8nhlFuppanz8hYgXr8VvlfKh4gLC25ud3c90A==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/json.min.js" integrity="sha512-37sW1XqaJmseHAGNg4N4Y01u6g2do6LZL8tsziiL5CMXGy04Th65OXROw2jeDeXLo5+4Fsx7pmhEJJw77htBFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/dockerfile.min.js" integrity="sha512-eRNl3ty7GOJPBN53nxLgtSSj2rkYj5/W0Vg0MFQBw8xAoILeT6byOogENHHCRRvHil4pKQ/HbgeJ5DOwQK3SJA==" crossorigin="anonymous"></script>
    <script>if (!(window.minisite || {}).skipHighlightJs) { hljs.highlightAll(); }</script>
    <script src="//www.yupiik.io/fusion/js/minisite.js?v=1.0.13-SNAPSHOT"></script>
    <script>$('.page-content-body').generatedNavMenu();</script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.3/fuse.min.js" integrity="sha512-neoBxVNv0UMXjoilAYGxfWrSsW6iAVclx7vQKdPJ9Peet1bM5YQjU0aIB8LtH8iNPa+pAyMZprBBw2ZQ/Q1LjQ==" crossorigin="anonymous"></script>

</body>
</html>
