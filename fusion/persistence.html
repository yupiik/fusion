<!DOCTYPE html>
<html lang="en">

<head>
    <title>Persistence</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Fusion framework aims at providing a very light java framework and graal native.">
    <meta name="author" content="Yupiik Minisite Generator">
    <meta name="generator" content="Yupiik Minisite Generator">
    
    <link rel="shortcut icon" href="//www.yupiik.io/fusion/images/favicon.png">

    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i|Montserrat:300,400,500,700" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/asciidoctor.js/1.5.5-5/css/asciidoctor.min.css" integrity="sha512-kI7tn5cuEg16kMeXnYmg8rEJPxbxzEM7Gsr191iQdLDevFBLXPCSU9aZWSVuP61tMZWU3nBAR1cJ7SmXnOGLZw==" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css" integrity="sha512-oc9+XSs1H243/FRN9Rw62Fn8EtxjEYWHXRvjS43YtueEewbS6ObfXcJNyohjHqVKFPoXXUxwc+q1K7Dee6vv9g==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/atom-one-dark.min.css" integrity="sha512-Fcqyubi5qOvl+yCwSJ+r7lli+CO1eHXMaugsZrnxuU4DVpLYWXTVoHy55+mCb4VZpMgy7PBhV7IiymC0yu9tkQ==" crossorigin="anonymous" />
    <style>
        :root {
            /* YUPIIK colors (from dark to light) */
            --yupiik-site-green: #46F72F;
            --yupiik-site-purple: #D858FF;
            --yupiik-site-blue-light: #02ABEA;
            --yupiik-site-blue-dark: #056EBB;
            --yupiik-site-grey-light: #F4F4F4;
            --yupiik-site-grey-dark: #212121;

            --yupiik-blue1: var(--yupiik-site-blue-dark);
            --yupiik-blue2: var(--yupiik-site-blue-dark);
            --yupiik-blue3: var(--yupiik-site-blue-dark);

            --yupiik-color-white: #fff;
            --yupiik-color-black: #000;

            --yupiik-color-gray-0: var(--yupiik-color-white);
            --yupiik-color-gray-100: #f5f6f7;
            --yupiik-color-gray-200: #ebedf0;
            --yupiik-color-gray-300: #dadde1;
            --yupiik-color-gray-400: #ccd0d5;
            --yupiik-color-gray-500: #bec3c9;
            --yupiik-color-gray-600: #8d949e;
            --yupiik-color-gray-700: #606770;
            --yupiik-color-gray-800: #444950;
            --yupiik-color-gray-900: #1c1e21;
            --yupiik-color-gray-1000: var(--yupiik-color-black);

            --yupiik-color-emphasis-0: var(--yupiik-color-gray-0);
            --yupiik-color-emphasis-100: var(--yupiik-color-gray-100);
            --yupiik-color-emphasis-200: var(--yupiik-color-gray-200);
            --yupiik-color-emphasis-300: var(--yupiik-color-gray-300);
            --yupiik-color-emphasis-400: var(--yupiik-color-gray-400);
            --yupiik-color-emphasis-500: var(--yupiik-color-gray-500);
            --yupiik-color-emphasis-600: var(--yupiik-color-gray-600);
            --yupiik-color-emphasis-700: var(--yupiik-color-gray-700);
            --yupiik-color-emphasis-800: var(--yupiik-color-gray-800);
            --yupiik-color-emphasis-900: var(--yupiik-color-gray-900);
            --yupiik-color-emphasis-1000: var(--yupiik-color-gray-1000);
            --yupiik-color-content: var(--yupiik-color-emphasis-900);

            --yupiik-font-family-base: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            --yupiik-font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            --yupiik-font-size-base: 100%;

            --yupiik-font-weight-light: 300;
            --yupiik-font-weight-normal: 400;
            --yupiik-font-weight-semibold: 500;
            --yupiik-font-weight-bold: 700;

            --yupiik-font-weight-base: var(--yupiik-font-weight-normal);
            --yupiik-line-height-base: 1.65;
            --yupiik-font-weight-light: 300;
            --yupiik-font-weight-normal: 400;
            --yupiik-font-weight-semibold: 500;
            --yupiik-font-weight-bold: 700;

            --yupiik-font-weight-base: var(--yupiik-font-weight-normal);
            --yupiik-line-height-base: 1.65;

            --yupiik-global-spacing: 1rem;
            --yupiik-spacing-vertical: var(--yupiik-global-spacing);
            --yupiik-spacing-horizontal: var(--yupiik-global-spacing);

            --yupiik-h1-font-size: 2rem;
            --yupiik-h2-font-size: 1.5rem;
            --yupiik-h3-font-size: 1.25rem;
            --yupiik-h4-font-size: 1rem;
            --yupiik-h5-font-size: 0.875rem;
            --yupiik-h6-font-size: 0.85rem;

            --yupiik-heading-color: var(--yupiik-blue1);
            --yupiik-heading-margin-top: 0;
            --yupiik-heading-margin-bottom: var(--yupiik-spacing-vertical);
            --yupiik-heading-font-family: var(--yupiik-font-family-base);
            --yupiik-heading-font-weight: var(--yupiik-font-weight-bold);
            --yupiik-heading-line-height: 1.25;
        }
    </style>
    
    <link id="theme-style" rel="stylesheet" href="//www.yupiik.io/fusion/css/theme.css?v=1.0.19-SNAPSHOT">
</head>
<body>
    <header class="header fixed-top">
        <div class="branding docs-branding">
            <div class="container-fluid position-relative py-2">
                <div class="docs-logo-wrapper">
	                <div class="site-logo"><a title="Home" class="navbar-brand" href="//www.yupiik.io/fusion/index.html">
	                <img class="logo-icon mr-2" src="//www.yupiik.io/fusion/images/logo.svg" alt="logo">
	                <span class="logo-text">Fusion <span class="text-alt">Documentation</span></span></a></div>
                </div>
	            <div class="docs-top-utilities d-flex justify-content-end align-items-center">
					
					<li class="list-inline-item"><a title="Search" id="search-button" href="#" data-toggle="modal" data-target="#searchModal"><i data-toggle="tooltip" data-placement="top" title="Search" class="fas fa-search"></i></a></li>

					<ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
						
						<li class="list-inline-item"><a title="LinkedIn" target="_blank" href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Twitter" target="_blank" href="https://twitter.com/Yupiik/"><i class="fab fa-twitter fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Github" target="_blank" href="https://www.github.com/yupiik/fusion"><i class="fab fa-github fa-fw"></i></a></li>
		            </ul>
	            </div>
            </div>
        </div>
    </header>
	<div class="page">
        <div class="page-navigation-left">
            <h3>Menu</h3>
            <ul>
                <li>
                    <a title="Fusion Stack" href="//www.yupiik.io/fusion/fusion/index.html">
                        <i class="fas fa-play"></i>Getting Started
                    </a>
                </li>                <li>
                    <a title="Fusion framework Examples" href="//www.yupiik.io/fusion/fusion/examples.html">
                        <i class="fas fa-vial"></i>Example
                    </a>
                </li>                <li>
                    <a title="Fusion framework Setup" href="//www.yupiik.io/fusion/fusion/setup.html">
                        <i class="fas fa-building"></i>Setup
                    </a>
                </li>                <li>
                    <a title="Fusion CLI" href="//www.yupiik.io/fusion/fusion/cli.html">
                        <i class="fas fa-terminal"></i>CLI
                    </a>
                </li>                <li>
                    <a title="Fusion JSON support" href="//www.yupiik.io/fusion/fusion/json.html">
                        <i class="fas fa-wifi"></i>JSON
                    </a>
                </li>                <li>
                    <a title="framework and GraalVM (native-image)" href="//www.yupiik.io/fusion/fusion/graalvm.html">
                        <i class="fas fa-server"></i>GraalVM
                    </a>
                </li>
            </ul>
        </div>

        <div id="fusion-persistence-html-container" class="container page-content fusion-persistence-html ">
                        <div class="page-header">
                <h1>Persistence</h1>
            </div>
            <div class="page-content-body">
                <div id="preamble">
 <div class="sectionbody">
 <p> <div class="paragraph">
 <p>
The Fusion Persistence module provides capabilities to deal with common database operations.
 </p>
 </div>
</p>
 </div>
 </div>
 <div class="admonitionblock tip">
  <table>
    <tbody>
     <tr>
      <td class="icon">
     <div class="title">TIP</div>
       </td>
      <td class="content">
 <div class="paragraph">
 <p>even if the default <code>Database</code> is the more tempting thanks its simplicity, we encourage you to go with the <code>ContextLessDatabase</code> instead which has a way better design, in particular on recent JVM.</p>
 </div>
    </td>
   </tr>
      </tbody>
  </table>
 </div>
 <div class="sect1" id="_project_definition">
  <h2>Project definition</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>First you need to add the <b>fusion-persistence</b> module in your <code>pom.xml</code> dependencies section:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.yupiik.fusion&lt;/groupId&gt;
    &lt;artifactId&gt;fusion-persistence&lt;/artifactId&gt;
    &lt;version&gt;${fusion.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
 </div>
 </div>
 <div class="admonitionblock important">
  <table>
    <tbody>
     <tr>
      <td class="icon">
     <div class="title">IMPORTANT</div>
       </td>
      <td class="content">
 <div class="paragraph">
 <p>annotations - design API - is in <code>fusion-build-api</code> and is only useful at build time.</p>
 </div>
    </td>
   </tr>
      </tbody>
  </table>
 </div>
 </div>
 </div>
 <div class="sect1" id="_configuration">
  <h2>Configuration</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>You need to add the <code>tomcat-jdbc</code> dependency to use TomcatDataSource pool:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
    &lt;artifactId&gt;tomcat-jdbc&lt;/artifactId&gt;
    &lt;version&gt;${tomcat.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>You can find the full available properties to configure the pool  <a href="https://tomcat.apache.org/tomcat-10.1-doc/jndi-datasource-examples-howto.html">here</a>
</p>
 </div>
 <div class="sect2" id="_default_configuration">
  <h3>Default configuration</h3>
 <div class="sectionbody">
 <div class="paragraph">
 <p>Default configuration can implicitly configure a datasource if you set <code>fusion.persistence.datasource.url</code> value in system properties or environment variables (it uses <code>io.yupiik.fusion.framework.api.configuration.Configuration</code>).</p>
 </div>
 <div class="paragraph">
 <p>All keys have <code>fusion.persistence.datasource.</code> prefix and follow <code>org.apache.tomcat:tomcat-jdbc</code> configuration (see  <a href="https://tomcat.apache.org/tomcat-10.1-doc/jdbc-pool.html).">https://tomcat.apache.org/tomcat-10.1-doc/jdbc-pool.html).</a>
</p>
 </div>
 <div class="paragraph">
 <p>
Here are the available keys:
 </p>
 </div>
 <div class="paragraph">
 <p> <code>fusion.persistence.datasource.defaultAutoCommit</code> <code>fusion.persistence.datasource.driver</code> <code>fusion.persistence.datasource.logAbandoned</code> <code>fusion.persistence.datasource.maxActive</code> <code>fusion.persistence.datasource.minEvictableIdleTime</code> <code>fusion.persistence.datasource.minIdle</code> <code>fusion.persistence.datasource.password</code> <code>fusion.persistence.datasource.removeAbandoned</code> <code>fusion.persistence.datasource.removeAbandonedTimeout</code> <code>fusion.persistence.datasource.testOnBorrow</code> <code>fusion.persistence.datasource.testOnReturn</code> <code>fusion.persistence.datasource.testWhileIdle</code> <code>fusion.persistence.datasource.timeBetweenEvictionRuns</code> <code>fusion.persistence.datasource.url</code> <code>fusion.persistence.datasource.username</code> <code>fusion.persistence.datasource.validationQuery</code> <code>fusion.persistence.datasource.validationQueryTimeout</code> <code>fusion.persistence.datasource.rollbackOnReturn</code> <code>fusion.persistence.datasource.forceReadOnly</code> (should <code>setReadOnly</code> be called on <code>.read()</code> invocations)</p>
 </div>
 <div class="admonitionblock important">
  <table>
    <tbody>
     <tr>
      <td class="icon">
     <div class="title">IMPORTANT</div>
       </td>
      <td class="content">
 <div class="paragraph">
 <p>this (implicit) datasource requires to define its bounds/transactions calling <code>read</code> or <code>write</code> wrapper, you can inject <code>TomcatDataSource</code> to have these methods.</p>
 </div>
    </td>
   </tr>
      </tbody>
  </table>
 </div>
 </div>
 </div>
 </div>
 </div>
 <div class="sect1" id="_entity">
  <h2>Entity</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>Fusion support java <b>record</b> for database entity definition.</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Table(&quot;CUSTOMER&quot;) <b class="conum">(1)</b>
public record CustomerEntity(
        @Id(autoIncremented = true, order = 0) Integer id, <b class="conum">(2)</b>
        @Column String firstname,
        @Column(name = &quot;LAST_NAME&quot;) String lastname, <b class="conum">(3)</b>
        @Column String title,
        @Column String organization) {
}</code></pre>
 </div>
 </div>
 <div class="colist arabic">
  <ol>
   <li>
 <span>
Activate the record as an entity and setting the name enables to force the table name, if not set it is the simple class name which is used.
 </span>
   </li>
   <li>
 <span>
Indicate the primary key of the entity.
 </span>
<b>autoIncremented</b> <span>
: It is recommended to use a UUID or equivalent as identifier but when mapping an existing database you can need to synchronize and use java.sql.Statement.getGeneratedKeys to map the keys. For these cases, set this toggle to true. If your model is a POJO the value is directly set but if it is a record the value will be copied at insert time.
 </span>
<b>order</b> <span>
: When using multiple times this annotation, enables to sort the fields.
 </span>
   </li>
   <li>
 <span>
Activate the field as a column table. If the name is not set, the field name is used as column name.
 </span>
   </li>
  </ol>
 </div>
 <div class="sect2" id="_operation_on_entity">
  <h3>Operation on entity</h3>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
Some hooks are available and can be added in the entity record directly:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OnInsert
    public CustomerEntity onInsert() {
        return id() == null ?
                new CustomerEntity(UUID.randomUUID().toString(), firstname(), lastname(), title(), organization()) :
                this;
    }

    @OnLoad
    public CustomerEntity onLoad() {
        return Objects.isNull(title()) ?
                new CustomerEntity(id(), firstname(), lastname(), &quot;None&quot;, organization()) :
                this;
    }

    @OnUpdate
    private CustomerEntity onUpdate() {
        return this;
    }

    @OnDelete
    private void onDelete() {
        // no-op
    }</code></pre>
 </div>
 </div>
 <div class="admonitionblock tip">
  <table>
    <tbody>
     <tr>
      <td class="icon">
     <div class="title">TIP</div>
       </td>
      <td class="content">
 <div class="paragraph">
 <p><code>fusion-persistence</code> in container mode (default) enables to pass injection parameters to callbacks which can ease the wiring for auditing or transversal features relying on services.</p>
 </div>
    </td>
   </tr>
      </tbody>
  </table>
 </div>
 </div>
 </div>
 </div>
 </div>
 <div class="sect1" id="_querying">
  <h2>Querying</h2>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
It's very simple to execute common action, you just need to inject the database and use it with the entity.
 </p>
 </div>
 <div class="sect2" id="_crud">
  <h3>CRUD</h3>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
Fusion database provide common in-house CRUD operations.
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class CustomerDao {

    private final Database database;
    private final TomcatDataSource dataSource;

    public CustomerDao(final Database database, final TomcatDataSource dataSource) {
        this.database = database;
        this.dataSource = dataSource;
    }

    public CustomerEntity findCustomer(final String id) {
        return dataSource.read(() -&gt; database.findById(CustomerEntity.class, id));
    }

    public List&lt;CustomerEntity&gt; findAllCustomer() {
        return dataSource.read(() -&gt; database.findAll(CustomerEntity.class));
    }

    public void createCustomer(CustomerEntity entity) {
        try {
            dataSource.write(() -&gt; database.insert(entity));
        } catch (Error error) {
            // error, rollback is managed by datasource, no need to manage it by hand
        }
    }

    public void updateCustomer(CustomerEntity entity) {
        try {
            dataSource.write(() -&gt; database.update(entity));
        } catch (Error error) {
            // error, rollback is managed by datasource, no need to manage it by hand
        }
    }

    public void deleteCustomer(CustomerEntity entity) {
        try {
            dataSource.write(() -&gt; database.delete(entity));
        } catch (Error error) {
            // error, rollback is managed by datasource, no need to manage it by hand
        }
    }
}</code></pre>
 </div>
 </div>
 </div>
 </div>
 <div class="sect2" id="_custom_queries">
  <h3>Custom queries</h3>
 <div class="sectionbody">
 <div class="paragraph">
 <p>
You can use custom SQL queries by using the entity model from the database helper:
 </p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final var customer = database.entity(Customer.class);

final var sql = &quot;SELECT &quot; + String.join(&quot;, &quot;,
        customer.concatenateColumns(new Entity.ColumnsConcatenationRequest())) +
        &quot;FROM &quot; + customer.getTable() +
        &quot;WHERE name = ?&quot;;
final var lines = database.query(Customer.class, sql, b -&gt; b.bind(&quot;the-name&quot;));</code></pre>
 </div>
 </div>
 </div>
 </div>
 <div class="sect2" id="_advanced_queries">
  <h3>Advanced queries</h3>
 <div class="sectionbody">
 <div class="paragraph">
 <p>For advanced queries you can use a virtual table (it is a plain table but the <code>@Table</code> annotation is ignored) which would be used as project based on query aliases:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final var entity1 = database.entity(Entity1.class);
final var entity2 = database.entity(Entity2.class);

final var sql = &quot;SELECT DISTINCT &quot; + String.join(&quot;, &quot;,
        entity1.concatenateColumns(new Entity.ColumnsConcatenationRequest()
                .setPrefix(&quot;e1.&quot;).setAliasPrefix(&quot;&quot;)),
        entity2.concatenateColumns(new Entity.ColumnsConcatenationRequest()
                .setPrefix(&quot;e2.&quot;).setAliasPrefix(&quot;e2&quot;).setIgnored(Set.of(&quot;e1_id&quot;)))) + &quot; &quot; +
        &quot;FROM &quot; + entity1.getTable() + &quot; e1 &quot; +
        &quot;LEFT JOIN ENTITY2 admin on e2.e1_id = e1.id &quot; +
        &quot;WHERE e1.id = ?&quot;;
final var lines = database.query(JoinModel.class, sql, b -&gt; b.bind(&quot;the-id&quot;));</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>with <code>JoinModel</code> being something like:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Table(name = &quot;ignored&quot;)
public record JoinModel (
    // e1
    @Id private String id,
    @Column private String name,
    // e2
    @Id private String e2Id,
    @Column private String e2Label) {
}</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>Or you can also use <code>Entity</code> binder capacity:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final var e2Alias = &quot;e2&quot;;
final var e2Ignored = Set.of(&quot;e1Id&quot;);
final var sql = &quot;SELECT DISTINCT &quot; + String.join(&quot;, &quot;,
        entity1.concatenateColumns(new Entity.ColumnsConcatenationRequest()
                .setPrefix(&quot;e1.&quot;).setAliasPrefix(&quot;&quot;)),
        entity2.concatenateColumns(new Entity.ColumnsConcatenationRequest()
                .setPrefix(e2Alias + '.').setAliasPrefix(e2Alias).setIgnored(e2Ignored))) + &quot; &quot; +
        &quot;FROM ENTITY1 e1&quot; +
        &quot; LEFT JOIN ENTITY2 admin on e2.e1_id = e1.id &quot; +
        &quot;WHERE e1.id = ?&quot;;

// precompile the binders
var fields = database.entity(Entity1.class).getOrderedColumns().stream()
            .map(Entity.ColumnMetadata::javaName)
            .collect(toList());
final var e1Binder = database.entity(Entity1.class)
        .mapFromPrefix(&quot;&quot;, fields.toArray(String[]::new));

fields.addAll( // continue to go through the queries fields appending the next entity ones - binder will pick the column indices right this way
        database.entity(Entity2.class)
            .getOrderedColumns().stream()
            .filter(c -&gt; !e2Ignored.contains(c.javaName()))
            .map(c -&gt; c.toAliasName(e2Alias))
            .collect(toList()));
final var e2Binder = database.entity(Entity2.class)
        .mapFromPrefix(e2Alias, fields.toArray(String[]::new));

// at runtime
final var lines = database.query(
        sql,
        b -&gt; b.bind(&quot;the-id&quot;),
        result -&gt; {
            // bind current resultSet and iterate over each line of the resultSet
            return result.mapAll(line -&gt; Tuple2.of(e1Binder.apply(line), e2Binder.apply(line)));
        });
// lines will get both Entity1 and Entity2 instances, then you can just filter them checking there is an id or not for example
// and join them as needed to create your output model</code></pre>
 </div>
 </div>
 </div>
 </div>
 <div class="sect2" id="_get_rid_of_thread_local_usage">
  <h3>Get rid of thread local usage</h3>
 <div class="sectionbody">
 <div class="paragraph">
 <p>Most of <code>Database</code> API relies on an implicit connection given from the <code>DataSource</code>. All these implementations rely on <code>ThreadLocal</code> to handle properly transactions (until you just do CRUD).</p>
 </div>
 <div class="paragraph">
 <p>To avoid that, we recommend you to use <code>ContextLessDatabase</code> instead. It is exactly the same API except it takes a <code>Connection</code> as parameter replacing the <code>ThreadLocal</code>:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try (final var connection = dataSource.getConnection()) {
 database.insert(connection, entity);
}</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>The big advantage is when used with <code>read()</code> or <code>write()</code> connection provider wrappers:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">dataSource.write(connection -&gt; {
 database.insert(connection, entity);
 aServiceDoingAnInsert(connection);
});</code></pre>
 </div>
 </div>
 <div class="paragraph">
 <p>With this pattern no more need of any <code>ThreadLocal</code>. You can rely on <code>TransactionManager</code> to ease the overall usage.</p>
 </div>
 <div class="paragraph">
 <p>In terms of configuration, the same than for the thread local case is supported, you just need to set <code>fusion.persistence.contextLess</code> to <code>true</code> to enable the context less case and inject a plain <code>DataSource</code> instead of <code>TomcatDataSource</code>:</p>
 </div>
 <div class="listingblock">
 <div class="content">
 <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyPersistingService {
    private final TransactionManager txMgr;
    private final ContextLessDatabase db;

    // constructor to get injections

    public void insert(final MyModel model) {
        txMgr.write(connection -&gt; db.insert(connection, model));
    }
}</code></pre>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>
                
                
            </div>
        </div>
    <div class="page-navigation-right">
        <h3>Navigation</h3>
        <nav class="generated-nav-menu"></nav>
    </div>
    </div>
    <footer class="footer pb-5">
	    <div class="text-center">
		    <ul class="social-list list-unstyled">
                <li class="list-inline-item"><a title="LinkedIn" target="_blank" href="https://www.linkedin.com/company/yupiik/"><i class="fab fa-linkedin fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Twitter" target="_blank" href="https://twitter.com/Yupiik/"><i class="fab fa-twitter fa-fw"></i></a></li>
              <li class="list-inline-item"><a title="Github" target="_blank" href="https://www.github.com/yupiik/fusion"><i class="fab fa-github fa-fw"></i></a></li>
	        </ul>
            <small class="copyright">Â© 2024 <strong><a href="https://www.yupiik.com">Yupiik</a></strong>. All Rights Reserved</small> | <a href="https://www.yupiik.com/terms-of-use/">Terms of use</a> | <a href="https://www.yupiik.com/privacy-policy/">Privacy policy</a>
	    </div>
    </footer>

    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalLabel">Search</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form onsubmit="return false;" class="form-inline">
          <div class="form-group">
            <label for="searchInput"><b>Search: </b></label>
            <input class="form-control" id="searchInput" placeholder="Enter search text and hit enter...">
          </div>
        </form>
        <div class="search-hits"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js" integrity="sha512-8qmis31OQi6hIRgvkht0s6mCOittjMa9GMqtK9hes5iEQBQE/Ca6yGE5FsW36vyipGoWQswBj/QBm2JR086Rkw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/highlight.min.js" integrity="sha512-d00ajEME7cZhepRqSIVsQVGDJBdZlfHyQLNC6tZXYKTG7iwcF8nhlFuppanz8hYgXr8VvlfKh4gLC25ud3c90A==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/bash.min.js" integrity="sha512-Hg0ufGEvn0AuzKMU0psJ1iH238iUN6THh7EI0CfA0n1sd3yu6PYet4SaDMpgzN9L1yQHxfB3yc5ezw3PwolIfA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/json.min.js" integrity="sha512-37sW1XqaJmseHAGNg4N4Y01u6g2do6LZL8tsziiL5CMXGy04Th65OXROw2jeDeXLo5+4Fsx7pmhEJJw77htBFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/dockerfile.min.js" integrity="sha512-eRNl3ty7GOJPBN53nxLgtSSj2rkYj5/W0Vg0MFQBw8xAoILeT6byOogENHHCRRvHil4pKQ/HbgeJ5DOwQK3SJA==" crossorigin="anonymous"></script>
    <script>if (!(window.minisite || {}).skipHighlightJs) { hljs.highlightAll();
function addCopyButtons(clipboard) {
  document.querySelectorAll('pre > code').forEach(function (codeBlock) {
  var button = document.createElement('button');  button.className = 'copy-code-button';  button.type = 'button';  button.innerText = 'Copy';  button.addEventListener('click', function () {   clipboard.writeText(codeBlock.innerText).then(function () {   button.blur();   button.innerText = 'Copied!';   setTimeout(function () { button.innerText = 'Copy'; }, 2000); }, function (error) { button.innerText = 'Error'; });  });  var pre = codeBlock.parentNode;  if (pre.parentNode.classList.contains('highlight')) {   var highlight = pre.parentNode; highlight.parentNode.insertBefore(button, highlight);  } else { pre.parentNode.insertBefore(button, pre); } });}
if (navigator && navigator.clipboard) { addCopyButtons(navigator.clipboard);} else { var script = document.createElement('script'); script.src = '//cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.7.0/clipboard-polyfill.promise.js'; script.integrity = 'sha256-waClS2re9NUbXRsryKoof+F9qc1gjjIhc2eT7ZbIv94='; script.crossOrigin = 'anonymous'; script.onload = function() {addCopyButtons(clipboard);}; document.body.appendChild(script);} }</script>
    <script src="//www.yupiik.io/fusion/js/minisite.js?v=1.0.19-SNAPSHOT"></script>
    <script>$('.page-content-body').generatedNavMenu();</script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.3/fuse.min.js" integrity="sha512-neoBxVNv0UMXjoilAYGxfWrSsW6iAVclx7vQKdPJ9Peet1bM5YQjU0aIB8LtH8iNPa+pAyMZprBBw2ZQ/Q1LjQ==" crossorigin="anonymous"></script>

</body>
</html>
